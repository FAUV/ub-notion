import{j as e,u as C}from"./vendor-query-CfuGqJst.js";import{r as h}from"./vendor-react-Ba_DDsk4.js";import{i as D}from"./importCsv-Dai6I4rs.js";import{V as T}from"./ViewBar-GmxfLOF8.js";import{u as k,a as A,D as I,c as L,P as M,b as P,S as w,v as R,d as E,C as O}from"./vendor-dnd-DPzRzUPU.js";import{e as $}from"./vendor-charts-Ci5G67-A.js";import{n as v,s as y,a as q,b as F,c as Q,f as V}from"./index-uMaUSKow.js";import{p as _}from"./parseISO-Clwiv-83.js";import{u as K,a as B,t as z}from"./tasks-t6ey88ep.js";function U(a,n,t){const[l,c]=v(t==null?void 0:t.in,a,n);return+y(l)==+y(c)}function W(a,n){const t=q(a,n==null?void 0:n.in);return t.setDate(1),t.setHours(0,0,0,0),t}function Y(a,n,t){const[l,c]=v(t==null?void 0:t.in,a,n);return l.getFullYear()===c.getFullYear()&&l.getMonth()===c.getMonth()}const H=["To Do","In Progress","Review","Done"];function J({task:a}){return e.jsxs("div",{className:"card p-3 text-sm",children:[e.jsx("div",{className:"font-medium",children:a.title}),e.jsxs("div",{className:"text-xs opacity-60",children:[a.assignee??"—"," · ",a.priority??"—"]})]})}function G({task:a,lane:n}){const{setNodeRef:t,attributes:l,listeners:c,transform:o,transition:r,isDragging:i}=E({id:a.id,data:{type:"task",task:a,status:a.status,lane:n}}),d={transform:O.Transform.toString(o),transition:r};return e.jsx("div",{ref:t,style:d,...l,...c,className:$(i&&"opacity-60"),children:e.jsx(J,{task:a})})}function X({status:a,tasks:n,lane:t,limit:l}){const c=`${t||"default"}::${a}`,{setNodeRef:o}=P({id:c,data:{type:"column",status:a,lane:t}});return e.jsxs("div",{ref:o,className:"space-y-3",children:[e.jsxs("div",{className:"text-xs uppercase tracking-wide opacity-60",children:[a," ",l?`(≤${l})`:""]}),e.jsx(w,{items:n.map(r=>r.id),strategy:R,children:e.jsx("div",{className:"space-y-3",children:n.map(r=>e.jsx(G,{task:r,lane:t},r.id))})})]})}function Z({tasks:a,swimlaneBy:n,wip:t,onChange:l}){const c=h.useMemo(()=>{if(!n)return{"":a};const i={};for(const d of a){const u=String(d[n]??"Sin asignar");i[u]=i[u]||[],i[u].push(d)}return i},[a,n]),o=k(A(M,{activationConstraint:{distance:5}})),r=h.useCallback(i=>{const{active:d,over:u}=i;if(!u)return;const m=d.data.current,s=u.data.current;if(!m)return;const{task:x,status:p}=m,g=m.lane,f=(s==null?void 0:s.type)==="task"?s.task.status:(s==null?void 0:s.type)==="column"?s.status:void 0,N=(s==null?void 0:s.type)==="task"||(s==null?void 0:s.type)==="column"?s.lane:g;if(!f||N!==g||f===p)return;const j=t==null?void 0:t[f];if(j&&a.filter(S=>S.status===f).length>=j){alert(`WIP excedido en ${f} (límite ${j})`);return}const b={...x,status:f};l==null||l(b,{from:p,to:f})},[l,a,t]);return e.jsx(I,{sensors:o,collisionDetection:L,onDragEnd:r,children:e.jsx("div",{className:"space-y-8",children:Object.entries(c).map(([i,d])=>e.jsxs("section",{children:[n&&e.jsxs("h3",{className:"text-sm font-medium mb-3 opacity-70",children:[n,": ",i]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:H.map(u=>e.jsx(X,{status:u,tasks:d.filter(m=>m.status===u),lane:i,limit:t==null?void 0:t[u]},`${i||"default"}::${u}`))})]},i))})})}function ee({onChange:a}){const[n,t]=h.useState(""),[l,c]=h.useState("All"),[o,r]=h.useState("All"),i=m=>{const s=m.target.value;t(s),a({q:s,status:l,assignee:o})},d=m=>{const s=m.target.value;c(s),a({q:n,status:s,assignee:o})},u=m=>{const s=m.target.value.trim(),x=s===""?"All":s;r(x),a({q:n,status:l,assignee:x})};return e.jsxs("div",{className:"card p-3 flex flex-wrap gap-2 items-center",children:[e.jsx("input",{className:"input",placeholder:"Buscar...",value:n,onChange:i}),e.jsxs("select",{className:"input",value:l,onChange:d,children:[e.jsx("option",{value:"All",children:"Todos"}),e.jsx("option",{value:"To Do",children:"To Do"}),e.jsx("option",{value:"In Progress",children:"In Progress"}),e.jsx("option",{value:"Review",children:"Review"}),e.jsx("option",{value:"Done",children:"Done"}),e.jsx("option",{value:"Blocked",children:"Blocked"}),e.jsx("option",{value:"Archived",children:"Archived"})]}),e.jsx("input",{className:"input",placeholder:"Responsable",value:o==="All"?"":o,onChange:u})]})}function se({tasks:a,month:n}){const t=n??new Date,l=F(W(t),{weekStartsOn:1}),c=[];for(let r=0;r<42;r++)c.push(Q(l,r));function o(r){return a.filter(i=>i.dueDate&&U(_(i.dueDate),r))}return e.jsxs("div",{className:"grid grid-cols-7 gap-2",children:[["Lun","Mar","Mié","Jue","Vie","Sáb","Dom"].map(r=>e.jsx("div",{className:"text-xs uppercase tracking-wide opacity-60",children:r},r)),c.map(r=>e.jsxs("div",{className:"card p-2 "+(Y(r,t)?"":"opacity-50"),children:[e.jsx("div",{className:"text-xs mb-1",children:V(r,"d")}),e.jsx("div",{className:"space-y-1",children:o(r).map(i=>e.jsx("div",{className:"text-xs truncate rounded-md px-2 py-1 bg-slate-100 dark:bg-slate-800",children:i.title},i.id))})]},r.toISOString()))]})}function me(){const[a,n]=h.useState("board"),[t,l]=h.useState({}),c=C(),{data:o=[],isLoading:r}=K(),i=B(),d=h.useMemo(()=>o.filter(s=>!(t.q&&!s.title.toLowerCase().includes(t.q.toLowerCase())||t.status&&t.status!=="All"&&s.status!==t.status||t.assignee&&t.assignee!=="All"&&(s.assignee??"").toLowerCase()!==String(t.assignee).toLowerCase())),[o,t]);async function u(s){var g;const x=(g=s.target.files)==null?void 0:g[0];if(!x)return;const p=await x.text();await D("tasks",p),await c.invalidateQueries({queryKey:z.all})}const m=h.useCallback(async(s,x)=>{i.mutate({id:s.id,status:s.status},{onError:p=>{console.error("No se pudo actualizar la tarea",p,{updated:s,meta:x})}})},[i]);return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h1",{className:"text-xl font-semibold",children:"Tareas"}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsxs("label",{className:"btn cursor-pointer",children:["Importar CSV",e.jsx("input",{type:"file",accept:".csv",className:"hidden",onChange:u})]})})]}),e.jsx(T,{items:[{key:"board",label:"Tablero"},{key:"list",label:"Lista"},{key:"calendar",label:"Calendario"}],active:a,onChange:n}),e.jsx(ee,{onChange:l}),r&&e.jsx("div",{className:"card p-4 text-sm opacity-80",children:"Cargando tareas..."}),a==="board"&&e.jsx(Z,{tasks:d,swimlaneBy:"assignee",wip:{"In Progress":5},onChange:m}),a==="list"&&e.jsx("div",{className:"card p-0 overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{className:"text-left text-xs uppercase tracking-wide text-slate-500 dark:text-slate-400 border-b border-slate-200 dark:border-slate-800",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3 font-medium",children:"Título"}),e.jsx("th",{className:"px-4 py-3 font-medium",children:"Estado"}),e.jsx("th",{className:"px-4 py-3 font-medium",children:"Prioridad"}),e.jsx("th",{className:"px-4 py-3 font-medium",children:"Responsable"}),e.jsx("th",{className:"px-4 py-3 font-medium",children:"Fecha límite"})]})}),e.jsxs("tbody",{className:"divide-y divide-slate-200 dark:divide-slate-800",children:[d.map(s=>{var x;return e.jsxs("tr",{className:"hover:bg-slate-50/60 dark:hover:bg-slate-800/60 transition-colors",children:[e.jsxs("td",{className:"px-4 py-3",children:[e.jsx("div",{className:"font-medium",children:s.title}),(x=s.tags)!=null&&x.length?e.jsx("div",{className:"mt-1 flex flex-wrap gap-1",children:s.tags.map(p=>e.jsx("span",{className:"rounded-full bg-slate-100 dark:bg-slate-800 px-2 py-0.5 text-xs",children:p},p))}):null]}),e.jsx("td",{className:"px-4 py-3",children:s.status}),e.jsx("td",{className:"px-4 py-3",children:s.priority??"—"}),e.jsx("td",{className:"px-4 py-3",children:s.assignee??"—"}),e.jsx("td",{className:"px-4 py-3",children:s.dueDate??"—"})]},s.id)}),!d.length&&!r&&e.jsx("tr",{children:e.jsx("td",{colSpan:5,className:"px-4 py-6 text-center text-sm opacity-70",children:"No hay tareas con los filtros seleccionados."})})]})]})}),a==="calendar"&&e.jsx("div",{className:"card p-4",children:e.jsx(se,{tasks:d})})]})}export{me as default};
